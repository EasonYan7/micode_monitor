# MiCode ACP Migration TODO

- [x] Fork/clone MiCodeMonitor codebase into current workspace
- [x] Create migration branch `micode/micode-acp-migration`
- [x] Introduce neutral provider/agent settings and compatibility migration
- [x] Implement ACP transport (`micode --experimental-acp`) in backend
- [x] Implement thread/session persistence shim for ACP (`sessions.json`)
- [x] Add ACP->app-server event adapter to preserve frontend contract
- [x] Wire command compatibility layer (keep old invoke names)
- [x] Update frontend types/settings labels to MiCode/Agent naming
- [x] Add tests for ACP mapping and settings migration
- [x] Run available checks and fix regressions (`npm run typecheck`, targeted vitest)
- [x] Sync slash autocomplete with MiCode ACP `available_commands_update`
- [x] Stabilize turn completion when ACP stream ends but prompt response stalls
- [x] Hide internal MiCode JSON routing preamble from assistant messages
- [x] Keep Debug/Log button always visible in sidebar corner actions
- [x] Harden internal JSON preamble stripping for mixed-content code blocks
- [x] Reduce first-response latency by proactively recreating empty ACP session ids
- [x] Treat user-triggered abort as cancelled turn (not fatal start error)
- [x] Normalize `turn/interrupt` when backend reports `Not currently generating`
- [x] Clear stale queued interrupt flags on non-retry turn errors
- [x] Guard against stale processing-without-turn blocking new sends
- [x] Populate GUI model picker from MiCode CLI bundle and apply selection via settings sync
- [x] Reconnect workspace ACP process when selected model changes to enforce runtime switch
- [x] Invalidate persisted thread session ids when model-triggered reconnect happens
- [x] Reduce model-switch/thread-switch stalls via approval mapping cleanup and collaboration-mode fallback
- [x] Stabilize ACP delta routing with active-turn session context (prevent cross-thread ghost chunks)
- [x] Emit per-turn token usage (`thread/tokenUsage/updated`) from MiCode session chat logs
- [x] Restore thread list visibility after restart by returning Codex-compatible `thread/list` payload shape
- [x] Auto-reconnect workspace session on `workspace not connected` and retry first command
- [x] Isolate background metadata/commit threads from foreground chat event stream
- [x] Disable local-run metadata helper call to prevent background-thread bleed into chat turns
- [x] Keep background helper threads fully ephemeral (memory-only, excluded from thread list/store)
- [x] Persist thread title from first user prompt (survives restart)
- [x] Make thread delete remove local persisted thread records (not archive-only)
- [x] Fallback sidebar usage display to token usage when rate-limit API is synthetic/empty
- [x] Preserve and display MCP tool identity (`server/tool`) across tool start/completion and approval flow
- [x] Persist per-thread conversation items locally and restore on `thread/resume`
- [x] Persist `thread/tokenUsage` to local storage across app restart
- [x] Aggregate sidebar usage by workspace threads (not only active thread)
- [x] Persist tool-call timeline and restore after restart
- [x] Split assistant bubbles before/after tool calls (avoid mixed text block)
- [x] Add frontend fallback split when backend reuses same assistant `itemId` across tool boundary
- [x] Add thread context menu action: Delete Conversation (keep usage)
- [x] Fix local usage session-root resolution (`.micodemonitor` fallback to global `~/.micode|~/.codex`) so homepage usage/TOP models can refresh
- [x] Add Display language setting (`English` / `中文`) and wire core home-page copy switch
- [x] Remove sidebar bottom-left Account button; localize sidebar usage labels (`Session/Weekly/Resets/Credits/Tokens`) for `中文`
- [x] Make settings updates optimistic (including language switch) with save-failure rollback
- [x] Prevent settings UI flashback on save errors (keep optimistic state; log save failure to Debug panel)
- [x] Remove Features experimental toggles (Multi-agent/Apps) from Settings UI
- [x] Remove MiCode remote backend host/token inputs from Settings UI
- [x] Expand Chinese UI localization: SettingsView major sections/controls + sidebar core labels/search/thread list actions
- [x] Rename creation entry to New Conversation / 新建对话
- [x] Remove New Clone Agent feature path (sidebar entry, menu event, accelerators, modal/hook/files, shortcuts UI)
- [x] Restore app-level slash routing for built-in commands and add `/skills` list command (plus fallback slash autocomplete entries)
- [x] Fix App MCP/skills visibility parity: pass configured `mcpServers` on ACP `session/new` and stop hardcoding empty `skills/list` response
- [x] Fix ACP `session/new` param schema regression (`mcpServers` must be array) to restore thread start/resume
- [x] Align slash UX with CLI capability: remove built-in `/skills` routing/autocomplete fallback
- [x] Align MCP slash behavior with CLI: stop local `/mcp` interception and pass `/mcp list` through to MiCode
- [x] Fix MCP tool detail visibility: parse ACP `tool_call` `rawInput` and `tool_call_update` `content[]` into tool arguments/result
- [x] Route exact `/mcp list` as deterministic local command (other `/mcp ...` remains passthrough)
- [x] Fallback MCP status source: when ACP returns empty/error, read configured servers from `settings.json` for `/mcp` display
- [x] Resolve MiCode home with global default (`~/.micode|~/.codex`) for all workspaces; only use workspace `.micodemonitor` as legacy fallback
- [x] Add startup doctor hint for missing MiCode CLI (show localized toast instead of silent failure)
- [x] Enforce slash command-only send path: slash-prefixed input is never forwarded to AI text prompt; `/mcp *` always runs local MCP handler
- [x] Keep Token terminology untranslated in Chinese UI (replace “代币” labels with “Token”)
- [x] Hide composer "Default" controls: remove collaboration selector when only default mode exists and hide thinking selector when no reasoning options
- [x] Restore Home top-model stats by parsing new MiCode `tmp/*/chats/session-*.json` usage source (not only legacy jsonl)
- [x] Fix usage root resolution: scan MiCode `tmp/<hash>/chats` directories (keep legacy `sessions` fallback) so Home model usage refreshes correctly
- [x] Fix workspace-scoped usage filtering for `tmp/<hash>/chats` by matching `projectHash` to selected workspace path hash
- [x] Fix locale leakage in English UI time labels: force relative/day formatting by app language (`en-US`/`zh-CN`) instead of system locale
- [x] Resolve frontend TypeScript baseline errors so `npm run typecheck` passes again
- [x] Add sidebar workspace action: clear project conversation history with confirm dialog, and wipe local history cache (`.micodemonitor` + global `~/.micode|~/.codex/tmp`)
- [x] Split README into standalone EN/CN versions (`README.md` + `README.zh-CN.md`) with language switch links and MiCode install guide
- [x] Update README install section with official MiCode one-click install commands (macOS/Linux and Windows)
- [x] Sync EN/CN README sections describing feature removals and behavior changes from original CodexMonitor
- [x] Update About panel branding/links (remove Twitter, point GitHub to EasonYan7/micode_monitor, update footer credit)
- [x] Point updater endpoint to fork release feed (`EasonYan7/micode_monitor`)
- [x] Fix release workflow updater artifacts/URLs to fork naming (`MiCodeMonitor*` + `latest.json`) and document release steps in EN/CN README
- [x] Disable in-app updater entry/flow (remove menu check-updates item and force updater controller idle/no-op)
- [x] Disable updater at build/runtime config level (remove updater plugin/permission and turn off updater artifacts in `tauri.conf.json`)
- [x] Add GitHub Actions Windows build workflow (`build-windows.yml`) for `windows-main` branch + manual dispatch + artifact upload
- [x] Update EN/CN README with Windows end-user download flow from `windows-main` Actions artifacts
- [x] Suppress workspace file index debug payload logs (`files/list` request/response) to keep Debug panel clean
- [x] Review temporary docs (`TODO 2.md`/`TODO 3.md`/`abc.md`) and keep `TODO.md` as canonical tracker
- [x] Reduce tool-event debug noise by truncating oversized `item/started|completed` payload fields and add fallback assistant completion hint after tool-only turn end
- [x] Fix macOS re-sign script daemon binary target (`codex_monitor_daemon`) with legacy fallback
- [x] Fix macOS bundle dylib relocation: embed `libgit2/libssh2/openssl` into app and rewrite `micode-monitor` linkage to `@rpath` (remove `/opt/homebrew/...` runtime deps)
- [x] Add release CI guard to fail macOS build if binary linkage still contains `/opt/homebrew` or `/usr/local/opt` absolute dylib paths
- [x] Pause release-by-default in GitHub Actions (`confirm_release` input required) and add notice job for source-first testing stage
- [x] Add local build guides for team testing (`BUILD_LOCAL.md` and `BUILD_LOCAL.zh-CN.md`)
- [x] Expand doctor checks (`node/npm/rustc/cargo/cmake/git/micode`) and update install hints for macOS/Windows/Linux
- [x] Update README EN/CN to explicitly state source-first distribution and local build flow
- [x] Add optional doctor auto-install mode (`npm run doctor:install`, `npm run doctor:win:install`) to reduce teammate setup friction
- [x] Ignore and untrack local runtime workspace data (`.micodemonitor/`) to avoid leaking local sessions/rules into repository history
- [x] Remove duplicate shadow files (`* 2.*` / `* 3.*`) that are not part of active compile chain
- [x] Add bootstrap scripts for beginners (`bootstrap:mac`, `bootstrap:win`) and package-manager fallback guidance (`brew`/`winget`/`choco`)
- [x] Rewrite README for beginner onboarding: make Chinese default on homepage (`README.md`) and swap English guide to `README.zh-CN.md`, with step-by-step download/install/build/config flow
- [x] Make plain filename references (for example `*.pdf`) clickable in chat markdown and route clicks through existing file opener flow
- [x] Fix WebKit startup crash in `remarkFileLinks` by removing unsupported Unicode property escapes and keeping CJK filename auto-link support
- [x] Prevent macOS `tauri dev/build` hangs on Desktop/iCloud file locks by pinning `CARGO_TARGET_DIR` to `~/.cache/micode-target` via wrapper scripts
- [x] Harden teammate onboarding run/build path: ignore `src-tauri/target`, add smart `npm run tauri dev|build` routing, and document cache-based bundle output locations
- [x] Fix startup first-paint layout issue where window content fully renders only after dragging (startup viewport sync + `100dvh` fallback)
- [x] Aggregate assistant streaming debug logs into a single rolling entry (replace per-delta spam with stream/final snapshots)
- [x] Make CI/release builds resilient without MiCode CLI preinstall (allow doctor skip via `MICODE_DOCTOR_SKIP_MICODE=1` in GitHub Actions)
- [x] Fix Windows build/runtime portability: move `sha2` to cross-platform dependency and make MiCode PATH discovery Windows-aware (`;` PATH, win shim dirs, `.exe/.cmd`)
- [x] Fix Windows model discovery fallback: resolve `micode` command-name via PATH and parse npm/winget shim wrappers (`%~dp0 ... @mi/mi-code-cli/dist/cli.js`)
- [ ] Final integration validation and documentation
- [ ] Enable true ACP session resume (`session/load`) once MiCode exposes `agentCapabilities.loadSession=true`; then replace current local-history + new-session fallback.

## Notes
- Rust full `cargo check` is blocked locally by missing `cmake` (required by `whisper-rs` build script).
- Completed checks:
  - `npm run typecheck`
  - `npm test -- src/features/settings/components/SettingsView.test.tsx src/features/home/components/Home.test.tsx src/features/settings/hooks/useAppSettings.test.ts`
- New reliability fix: auto-recreate ACP session and retry on `Session not found` during `turn/start`, and recreate session on `thread/resume`.
- ACP compatibility fix: keep required `mcpServers` in `session/new` and stabilize streaming item IDs per turn to avoid fragmented/missing UI replies.
- Build fix: align ACP update adapter turn index type with `message_index: u64` to restore successful Rust compile.
- UX parity fix: normalize ACP `turn/start` response to always include `result.turn.id` so frontend no longer shows false "Turn failed to start."
- Copy cleanup: replace user-facing "agent" prompts with "MiCode" in messaging/workspace entry points.
- Runtime fix: stop injecting `CODEX_HOME` into MiCode ACP process (use `MICODE_HOME` env key) to prevent prompt hangs in GUI.
- Runtime fix v2: do not inject any home env (`CODEX_HOME`/`MICODE_HOME`) for MiCode ACP by default; align runtime with terminal `micode`.
- Runtime safeguard: add 30s timeout for ACP session/prompt so UI cannot stay in Working indefinitely.
- UX fix: always optimistic-render user messages immediately after send.
- Stability tweak: increase ACP prompt timeout from 30s to 90s to reduce false timeout during long streaming turns.
- Data integrity fix: enforce unique sessionId per workspace thread and auto-repair duplicate session mappings in sessions.json.
- Slash passthrough mode (historical): app-level interception was temporarily disabled to forward `/...` directly to MiCode.
- Slash UX parity: wire ACP `available_commands_update` into composer so `/` suggestions now come from MiCode runtime commands.
- Slash command update: re-enable local routing for built-in commands (`/new`, `/review`, `/resume`, `/compact`, `/fork`, `/status`, `/mcp`, `/apps`, `/skills`) while still merging ACP-provided command suggestions.
- MCP/skills parity fix: ACP `session/new` now reads `~/.micode/settings.json` `mcpServers` and forwards them instead of forcing an empty list; `skills/list` now forwards to ACP instead of synthetic empty response.
- ACP compatibility fix: normalize `mcpServers` payload to protocol array shape (`name/command/args/env`) and skip unsupported config forms, preventing `Expected array, received object` startup failure.
- Slash capability alignment: keep `/skills` as plain text passthrough (not built-in command), because current CLI runtime may not expose `skills/list`.
- MCP command alignment: keep `/mcp` as plain text passthrough so users can use CLI-native subcommands like `/mcp list`.
- Tool detail fix: ACP adapter now extracts tool arguments from `rawInput` and output text from `content[]`, so `execute` tool cards are expandable with real details.
- MCP UX tweak: detect exact `/mcp list` in composer and call local MCP status formatter directly to avoid conversational detours before listing servers.
- MCP data fallback: list MCP status now falls back to `~/.micode/settings.json` (`mcpServers`) when runtime status API is empty/unavailable, so configured servers remain visible in App.
- Turn reliability: if ACP streamed chunks but `session/prompt` final response times out, synthesize `turn/completed` to prevent stuck "Working...".
- UX polish: strip internal fenced JSON routing payloads (e.g. title/worktreeName blocks) from assistant message display.
- UX tweak: keep Debug log entrypoint always visible (not only on warnings) for faster troubleshooting.
- JSON filtering refinement: strip internal routing code blocks when they include `title` + `worktree*` markers even if not strict JSON.
- Latency optimization: when local thread record has empty `sessionId`, recreate session before `session/prompt` to avoid one failed roundtrip.
- Abort flow: map `Request was aborted` to cancelled turn completion so UI does not surface false fatal `turn/start` errors.
- Interrupt flow: convert `Not currently generating` into benign interrupt success; avoid noisy debug/user errors.
- State hygiene: clear pending queued-interrupt flag on non-retry turn errors to prevent accidental cancel of next prompt.
- Composer send guard: treat `isProcessing=true` without `activeTurnId` for >15s as stale, so new input is sent instead of silently queued.
- Model picker parity: `model/list` now discovers visible models from installed MiCode CLI bundle (`AVAILABLE_MODELS`) instead of hardcoded `MiCode Auto`.
- Model apply path: when turn request carries `model`, backend updates `~/.micode/settings.json -> model.preferredModel` and recreates ACP session once so selection takes effect.
- Runtime model switch fix: GUI model change now triggers workspace ACP reconnect (process restart) before send, so MiCode loads new `preferredModel` immediately.
- Session hygiene fix: model-triggered reconnect now clears persisted thread `sessionId`s to prevent stale cross-thread event routing after ACP restart.
- Runtime UX fix: map ACP permission requests to readable `workspace/requestApproval` payloads (no more `command:["{}"]`) and include raw context for debugging.
- Compatibility fix: serve synthetic `collaborationMode/list` default in ACP adapter to avoid `Method not found` noise.
- Prompt parsing fix: ACP `turn/start` adapter now accepts legacy `text` payload (in addition to `input[]`) to prevent empty-prompt stalls on mixed invoke paths.
- Stream routing fix: session updates now bind to in-memory active prompt context (`sessionId -> threadId/turnId`) so assistant deltas don't drift to wrong thread after reconnect/model switch.
- Event-id stability fix: assistant/reasoning/tool fallback item IDs now derive from stable `turnId` instead of mutable `messageIndex`, reducing missing-message and stuck-working edge cases.
- Usage telemetry fix: adapter now reads `~/.micode/tmp/**/chats/session-*.json` by `sessionId` and emits `thread/tokenUsage/updated` after each completed turn with both `last` and cumulative `total` token breakdown.
- Thread list compatibility fix: ACP `thread/list` now returns both `result.data` and `result.threads`, with `cwd/preview/updatedAt` fields so existing frontend filtering and sorting can render persisted threads after app restart.
- First-send reliability fix: command handlers now detect `workspace not connected`, reconnect session automatically, and retry (`start_thread`, `send_user_message`, `resume/list/archive/compact/set_name/interrupt`).
- UX diagnostics fix: frontend now logs `thread/ensure error` to debug instead of silently dropping first message when thread bootstrap fails.
- Background-thread isolation fix: metadata/commit helper flows now start with `_background` and no longer emit foreground `thread/started`/`turn/*` events; ACP delta routing sends helper output only to callback collectors.
- Message-visibility safeguard: if internal-JSON stripping would hide an assistant message entirely, UI falls back to raw text so users never see a blank response row.
- Local-run stability fix: `useWorkspaceHome` no longer calls `generate_run_metadata` in `local` mode (keeps fallback title only), eliminating hidden background metadata turns that could leak JSON/title payloads into foreground chat.
- Background thread isolation v2: `_background` `thread/start` now creates in-memory temporary threads (not persisted in `.micodemonitor/sessions.json`, not listed in `thread/list`), and `turn/start`/`turn/interrupt`/`thread/archive` now resolve these temporary sessions without touching foreground thread state.
- UX persistence fix: auto-name new thread from first user prompt on `turn/start` and emit `thread/name/updated`; thread title now survives app restart via `.micodemonitor/sessions.json`.
- Data deletion fix: `thread/archive` now hard-removes foreground thread records from local `sessions.json`; frontend waits for backend success before removing thread in UI.
- Usage fallback fix: sidebar `Session`/`Credits` now falls back to `thread/tokenUsage/updated` values when `account/rateLimits/read` is synthetic or empty.
- Tool label fix: ACP adapter now caches per-`toolCallId` tool identity and emits `mcpToolCall` items with stable `server/tool` fields so UI can render real tool names instead of `Tool Call`/argument fragments.
- Approval bridge fix: when `session/request_permission` arrives before a tool update, adapter seeds tool identity from `toolCall.kind` and emits a synthetic `item/started` for consistent tool timeline.
- History persistence fix: backend now writes user/assistant thread items to `.micodemonitor/thread-items/<threadId>.json` during `turn/start`, and returns them in `thread/resume` (`thread.turns[*].items`) so restart/resume can reload message history.
- Usage persistence fix: frontend now persists `tokenUsageByThread` in localStorage (`micodemonitor.threadTokenUsage`) and restores it at startup.
- Usage aggregation fix: sidebar usage now sums token usage across all threads in the active workspace, with active-thread fallback when workspace aggregate is unavailable.
- History compatibility fix: persisted user messages now use `content[].type = "text"` so `thread/resume` can rebuild user bubbles correctly after app restart.
- Tool timeline persistence fix: adapter now persists `mcpToolCall` items (`in_progress/completed`) into local thread-items store and rehydrates them on resume.
- Streaming UX fix: adapter now rotates assistant `itemId` segment after `tool_call`, so post-tool response starts a new assistant bubble instead of appending to pre-tool text.
- Thread delete semantics fix: context menu now includes `Delete Conversation`; removing a thread no longer drops accumulated `tokenUsageByThread`.
- Tool bubble split fix v2: trigger assistant segment split on first `session/request_permission` tool presentation as well (not only `session/update.tool_call`), with de-dup guard to avoid double-split.
- Tool bubble split fix v3: frontend reducer now auto-splits same-`itemId` assistant stream when a tool/reasoning/review item appears in between, preventing pre/post-tool text from merging into one bubble.
- Tool bubble split fix v4: ACP adapter now also bumps assistant segment on `tool_call_update` (completion boundary), so post-tool text starts a fresh bubble even when permission/tool events arrive out of order.
- Home usage fallback fix: when local usage snapshot is empty, synthesize usage cards/charts from persisted `tokenUsageByThread` (workspace/all-workspace scope).
- Tool detail fix: preserve `mcpToolCall` `arguments/result/error` in adapter cache, realtime events, and persisted thread items so expand details shows meaningful content.
- Dev startup reliability fix (2026-02-14): `scripts/tauri-dev.sh` now auto-releases occupied dev ports `1420/1421` before `tauri dev` so stale Vite processes no longer cause blank Tauri window (frontend unreachable).
- Dev stability tweak (2026-02-14): default `tauri dev` to `--no-watch` (override with `MICODE_TAURI_NO_WATCH=0`) to avoid repeated app restarts caused by noisy file-change events in `src-tauri`.
- Dev runtime fix (2026-02-14): replace `remarkFileLinks` filename regex Unicode property escapes (`\p{...}`) with WebKit-safe explicit character ranges to prevent frontend boot crash (`Invalid regular expression`) while preserving Chinese/Japanese/Korean filename linking.
- Team run/build hardening (2026-02-14): add `scripts/tauri-cli.mjs` so `npm run tauri dev|build` auto-routes to guarded scripts (`tauri:dev`/`tauri:build` or Windows variants), preventing command misuse.
- Build cache portability tweak (2026-02-14): `scripts/tauri-dev.sh` and `scripts/tauri-build.sh` now default `CARGO_TARGET_DIR` to `${XDG_CACHE_HOME:-~/.cache}/micode-target` on macOS/Linux and improve port cleanup with force-kill fallback.
- Repo hygiene tweak (2026-02-14): ignore `src-tauri/target/` to prevent local Rust cache artifacts and stale absolute-path metadata from leaking into shared workflows.
- Docs sync (2026-02-14): README + BUILD_LOCAL EN/CN now document cache-based bundle output path and safe equivalent commands (`npm run tauri dev|build`).
- Full project health check (2026-02-27): verified `npm run doctor:strict`, `npm run lint`, `npm run typecheck`, `npm run test`, `cargo check` (`src-tauri`), and `npm run tauri:dev` startup smoke (`http://localhost:1420` reachable + app process launched).
- Startup layout fix (2026-02-27): add `useStartupViewportSync` (emit staged `resize` events on first mount) and root `100dvh` height fallback to avoid macOS overlay window first-frame partial render until manual drag/move.
- Debug UX fix (2026-02-27): aggregate `item/agentMessage/delta` logs by `workspace/thread/item` and upsert same debug entry id, then emit `item/agentMessage/final` on completion to keep log readable.
- CI reliability fix (2026-02-27): add `MICODE_DOCTOR_SKIP_MICODE` support in doctor scripts and enable it in CI/release/workflow build steps so Tauri compile jobs don't fail on runners missing `micode`.
- Windows portability fix (2026-02-28): `sha2` is now a common Rust dependency (not non-Windows-only), and MiCode path resolution now uses cross-platform PATH parsing (`env::split_paths/join_paths`) plus Windows fallback dirs (`WinGet\\Links`, `%APPDATA%\\npm`, `%USERPROFILE%\\.cargo\\bin`) and executable suffix probing.
- Windows model-list fix (2026-02-28): CLI bundle discovery now handles `agent_bin="micode"` (command name, resolve via PATH), npm/winget wrapper neighborhoods (`node_modules/@mi/mi-code-cli/dist/cli.js`), and wrapper token expansion like `%~dp0\\...\\cli.js`.
- ACP capability probe (2026-02-09): `session/load` / `session/resume` / `session/history` / `session/get` all return `Method not found`; initialize reports `agentCapabilities.loadSession=false`. Keep synthetic resume for now and revisit after MiCode ACP upgrade.
- i18n scope (phase 1): Display language switch is connected and homepage core copy is bilingual; full-app copy sweep remains for a future pass.
- Re-validated after fix:
  - `npm run typecheck`
  - `cargo check --manifest-path src-tauri/Cargo.toml`
  - `npm test -- src/features/settings/components/SettingsView.test.tsx src/features/home/components/Home.test.tsx src/features/settings/hooks/useAppSettings.test.ts`
  - `cargo test --manifest-path src-tauri/Cargo.toml translate_tool_call_event_includes_server_and_tool`
  - `cargo test --manifest-path src-tauri/Cargo.toml translate_tool_call_update_uses_cached_tool_identity`
