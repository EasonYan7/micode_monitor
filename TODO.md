# MiCode ACP Migration TODO

- [x] Fork/clone MiCodeMonitor codebase into current workspace
- [x] Create migration branch `micode/micode-acp-migration`
- [x] Introduce neutral provider/agent settings and compatibility migration
- [x] Implement ACP transport (`micode --experimental-acp`) in backend
- [x] Implement thread/session persistence shim for ACP (`sessions.json`)
- [x] Add ACP->app-server event adapter to preserve frontend contract
- [x] Wire command compatibility layer (keep old invoke names)
- [x] Update frontend types/settings labels to MiCode/Agent naming
- [x] Add tests for ACP mapping and settings migration
- [x] Run available checks and fix regressions (`npm run typecheck`, targeted vitest)
- [x] Sync slash autocomplete with MiCode ACP `available_commands_update`
- [x] Stabilize turn completion when ACP stream ends but prompt response stalls
- [x] Hide internal MiCode JSON routing preamble from assistant messages
- [x] Keep Debug/Log button always visible in sidebar corner actions
- [x] Harden internal JSON preamble stripping for mixed-content code blocks
- [x] Reduce first-response latency by proactively recreating empty ACP session ids
- [x] Treat user-triggered abort as cancelled turn (not fatal start error)
- [x] Normalize `turn/interrupt` when backend reports `Not currently generating`
- [x] Clear stale queued interrupt flags on non-retry turn errors
- [x] Guard against stale processing-without-turn blocking new sends
- [x] Populate GUI model picker from MiCode CLI bundle and apply selection via settings sync
- [ ] Final integration validation and documentation

## Notes
- Rust full `cargo check` is blocked locally by missing `cmake` (required by `whisper-rs` build script).
- Completed checks:
  - `npm run typecheck`
  - `npm test -- src/features/settings/components/SettingsView.test.tsx src/features/home/components/Home.test.tsx src/features/settings/hooks/useAppSettings.test.ts`
- New reliability fix: auto-recreate ACP session and retry on `Session not found` during `turn/start`, and recreate session on `thread/resume`.
- ACP compatibility fix: keep required `mcpServers` in `session/new` and stabilize streaming item IDs per turn to avoid fragmented/missing UI replies.
- Build fix: align ACP update adapter turn index type with `message_index: u64` to restore successful Rust compile.
- UX parity fix: normalize ACP `turn/start` response to always include `result.turn.id` so frontend no longer shows false "Turn failed to start."
- Copy cleanup: replace user-facing "agent" prompts with "MiCode" in messaging/workspace entry points.
- Runtime fix: stop injecting `CODEX_HOME` into MiCode ACP process (use `MICODE_HOME` env key) to prevent prompt hangs in GUI.
- Runtime fix v2: do not inject any home env (`CODEX_HOME`/`MICODE_HOME`) for MiCode ACP by default; align runtime with terminal `micode`.
- Runtime safeguard: add 30s timeout for ACP session/prompt so UI cannot stay in Working indefinitely.
- UX fix: always optimistic-render user messages immediately after send.
- Stability tweak: increase ACP prompt timeout from 30s to 90s to reduce false timeout during long streaming turns.
- Data integrity fix: enforce unique sessionId per workspace thread and auto-repair duplicate session mappings in sessions.json.
- Slash passthrough mode: disable app-level slash interception/autocomplete; forward `/...` directly to MiCode.
- Slash UX parity: wire ACP `available_commands_update` into composer so `/` suggestions now come from MiCode runtime commands.
- Turn reliability: if ACP streamed chunks but `session/prompt` final response times out, synthesize `turn/completed` to prevent stuck "Working...".
- UX polish: strip internal fenced JSON routing payloads (e.g. title/worktreeName blocks) from assistant message display.
- UX tweak: keep Debug log entrypoint always visible (not only on warnings) for faster troubleshooting.
- JSON filtering refinement: strip internal routing code blocks when they include `title` + `worktree*` markers even if not strict JSON.
- Latency optimization: when local thread record has empty `sessionId`, recreate session before `session/prompt` to avoid one failed roundtrip.
- Abort flow: map `Request was aborted` to cancelled turn completion so UI does not surface false fatal `turn/start` errors.
- Interrupt flow: convert `Not currently generating` into benign interrupt success; avoid noisy debug/user errors.
- State hygiene: clear pending queued-interrupt flag on non-retry turn errors to prevent accidental cancel of next prompt.
- Composer send guard: treat `isProcessing=true` without `activeTurnId` for >15s as stale, so new input is sent instead of silently queued.
- Model picker parity: `model/list` now discovers visible models from installed MiCode CLI bundle (`AVAILABLE_MODELS`) instead of hardcoded `MiCode Auto`.
- Model apply path: when turn request carries `model`, backend updates `~/.micode/settings.json -> model.preferredModel` and recreates ACP session once so selection takes effect.
