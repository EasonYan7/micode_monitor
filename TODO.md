# MiCode ACP Migration TODO

- [x] Fork/clone MiCodeMonitor codebase into current workspace
- [x] Create migration branch `micode/micode-acp-migration`
- [x] Introduce neutral provider/agent settings and compatibility migration
- [x] Implement ACP transport (`micode --experimental-acp`) in backend
- [x] Implement thread/session persistence shim for ACP (`sessions.json`)
- [x] Add ACP->app-server event adapter to preserve frontend contract
- [x] Wire command compatibility layer (keep old invoke names)
- [x] Update frontend types/settings labels to MiCode/Agent naming
- [x] Add tests for ACP mapping and settings migration
- [x] Run available checks and fix regressions (`npm run typecheck`, targeted vitest)
- [x] Sync slash autocomplete with MiCode ACP `available_commands_update`
- [x] Stabilize turn completion when ACP stream ends but prompt response stalls
- [x] Hide internal MiCode JSON routing preamble from assistant messages
- [x] Keep Debug/Log button always visible in sidebar corner actions
- [x] Harden internal JSON preamble stripping for mixed-content code blocks
- [x] Reduce first-response latency by proactively recreating empty ACP session ids
- [x] Treat user-triggered abort as cancelled turn (not fatal start error)
- [x] Normalize `turn/interrupt` when backend reports `Not currently generating`
- [x] Clear stale queued interrupt flags on non-retry turn errors
- [x] Guard against stale processing-without-turn blocking new sends
- [x] Populate GUI model picker from MiCode CLI bundle and apply selection via settings sync
- [x] Reconnect workspace ACP process when selected model changes to enforce runtime switch
- [x] Invalidate persisted thread session ids when model-triggered reconnect happens
- [x] Reduce model-switch/thread-switch stalls via approval mapping cleanup and collaboration-mode fallback
- [x] Stabilize ACP delta routing with active-turn session context (prevent cross-thread ghost chunks)
- [x] Emit per-turn token usage (`thread/tokenUsage/updated`) from MiCode session chat logs
- [x] Restore thread list visibility after restart by returning Codex-compatible `thread/list` payload shape
- [x] Auto-reconnect workspace session on `workspace not connected` and retry first command
- [x] Isolate background metadata/commit threads from foreground chat event stream
- [x] Disable local-run metadata helper call to prevent background-thread bleed into chat turns
- [x] Keep background helper threads fully ephemeral (memory-only, excluded from thread list/store)
- [x] Persist thread title from first user prompt (survives restart)
- [x] Make thread delete remove local persisted thread records (not archive-only)
- [x] Fallback sidebar usage display to token usage when rate-limit API is synthetic/empty
- [x] Preserve and display MCP tool identity (`server/tool`) across tool start/completion and approval flow
- [ ] Final integration validation and documentation

## Notes
- Rust full `cargo check` is blocked locally by missing `cmake` (required by `whisper-rs` build script).
- Completed checks:
  - `npm run typecheck`
  - `npm test -- src/features/settings/components/SettingsView.test.tsx src/features/home/components/Home.test.tsx src/features/settings/hooks/useAppSettings.test.ts`
- New reliability fix: auto-recreate ACP session and retry on `Session not found` during `turn/start`, and recreate session on `thread/resume`.
- ACP compatibility fix: keep required `mcpServers` in `session/new` and stabilize streaming item IDs per turn to avoid fragmented/missing UI replies.
- Build fix: align ACP update adapter turn index type with `message_index: u64` to restore successful Rust compile.
- UX parity fix: normalize ACP `turn/start` response to always include `result.turn.id` so frontend no longer shows false "Turn failed to start."
- Copy cleanup: replace user-facing "agent" prompts with "MiCode" in messaging/workspace entry points.
- Runtime fix: stop injecting `CODEX_HOME` into MiCode ACP process (use `MICODE_HOME` env key) to prevent prompt hangs in GUI.
- Runtime fix v2: do not inject any home env (`CODEX_HOME`/`MICODE_HOME`) for MiCode ACP by default; align runtime with terminal `micode`.
- Runtime safeguard: add 30s timeout for ACP session/prompt so UI cannot stay in Working indefinitely.
- UX fix: always optimistic-render user messages immediately after send.
- Stability tweak: increase ACP prompt timeout from 30s to 90s to reduce false timeout during long streaming turns.
- Data integrity fix: enforce unique sessionId per workspace thread and auto-repair duplicate session mappings in sessions.json.
- Slash passthrough mode: disable app-level slash interception/autocomplete; forward `/...` directly to MiCode.
- Slash UX parity: wire ACP `available_commands_update` into composer so `/` suggestions now come from MiCode runtime commands.
- Turn reliability: if ACP streamed chunks but `session/prompt` final response times out, synthesize `turn/completed` to prevent stuck "Working...".
- UX polish: strip internal fenced JSON routing payloads (e.g. title/worktreeName blocks) from assistant message display.
- UX tweak: keep Debug log entrypoint always visible (not only on warnings) for faster troubleshooting.
- JSON filtering refinement: strip internal routing code blocks when they include `title` + `worktree*` markers even if not strict JSON.
- Latency optimization: when local thread record has empty `sessionId`, recreate session before `session/prompt` to avoid one failed roundtrip.
- Abort flow: map `Request was aborted` to cancelled turn completion so UI does not surface false fatal `turn/start` errors.
- Interrupt flow: convert `Not currently generating` into benign interrupt success; avoid noisy debug/user errors.
- State hygiene: clear pending queued-interrupt flag on non-retry turn errors to prevent accidental cancel of next prompt.
- Composer send guard: treat `isProcessing=true` without `activeTurnId` for >15s as stale, so new input is sent instead of silently queued.
- Model picker parity: `model/list` now discovers visible models from installed MiCode CLI bundle (`AVAILABLE_MODELS`) instead of hardcoded `MiCode Auto`.
- Model apply path: when turn request carries `model`, backend updates `~/.micode/settings.json -> model.preferredModel` and recreates ACP session once so selection takes effect.
- Runtime model switch fix: GUI model change now triggers workspace ACP reconnect (process restart) before send, so MiCode loads new `preferredModel` immediately.
- Session hygiene fix: model-triggered reconnect now clears persisted thread `sessionId`s to prevent stale cross-thread event routing after ACP restart.
- Runtime UX fix: map ACP permission requests to readable `workspace/requestApproval` payloads (no more `command:["{}"]`) and include raw context for debugging.
- Compatibility fix: serve synthetic `collaborationMode/list` default in ACP adapter to avoid `Method not found` noise.
- Prompt parsing fix: ACP `turn/start` adapter now accepts legacy `text` payload (in addition to `input[]`) to prevent empty-prompt stalls on mixed invoke paths.
- Stream routing fix: session updates now bind to in-memory active prompt context (`sessionId -> threadId/turnId`) so assistant deltas don't drift to wrong thread after reconnect/model switch.
- Event-id stability fix: assistant/reasoning/tool fallback item IDs now derive from stable `turnId` instead of mutable `messageIndex`, reducing missing-message and stuck-working edge cases.
- Usage telemetry fix: adapter now reads `~/.micode/tmp/**/chats/session-*.json` by `sessionId` and emits `thread/tokenUsage/updated` after each completed turn with both `last` and cumulative `total` token breakdown.
- Thread list compatibility fix: ACP `thread/list` now returns both `result.data` and `result.threads`, with `cwd/preview/updatedAt` fields so existing frontend filtering and sorting can render persisted threads after app restart.
- First-send reliability fix: command handlers now detect `workspace not connected`, reconnect session automatically, and retry (`start_thread`, `send_user_message`, `resume/list/archive/compact/set_name/interrupt`).
- UX diagnostics fix: frontend now logs `thread/ensure error` to debug instead of silently dropping first message when thread bootstrap fails.
- Background-thread isolation fix: metadata/commit helper flows now start with `_background` and no longer emit foreground `thread/started`/`turn/*` events; ACP delta routing sends helper output only to callback collectors.
- Message-visibility safeguard: if internal-JSON stripping would hide an assistant message entirely, UI falls back to raw text so users never see a blank response row.
- Local-run stability fix: `useWorkspaceHome` no longer calls `generate_run_metadata` in `local` mode (keeps fallback title only), eliminating hidden background metadata turns that could leak JSON/title payloads into foreground chat.
- Background thread isolation v2: `_background` `thread/start` now creates in-memory temporary threads (not persisted in `.micodemonitor/sessions.json`, not listed in `thread/list`), and `turn/start`/`turn/interrupt`/`thread/archive` now resolve these temporary sessions without touching foreground thread state.
- UX persistence fix: auto-name new thread from first user prompt on `turn/start` and emit `thread/name/updated`; thread title now survives app restart via `.micodemonitor/sessions.json`.
- Data deletion fix: `thread/archive` now hard-removes foreground thread records from local `sessions.json`; frontend waits for backend success before removing thread in UI.
- Usage fallback fix: sidebar `Session`/`Credits` now falls back to `thread/tokenUsage/updated` values when `account/rateLimits/read` is synthetic or empty.
- Tool label fix: ACP adapter now caches per-`toolCallId` tool identity and emits `mcpToolCall` items with stable `server/tool` fields so UI can render real tool names instead of `Tool Call`/argument fragments.
- Approval bridge fix: when `session/request_permission` arrives before a tool update, adapter seeds tool identity from `toolCall.kind` and emits a synthetic `item/started` for consistent tool timeline.
- Re-validated after fix:
  - `npm run typecheck`
  - `cargo check --manifest-path src-tauri/Cargo.toml`
  - `npm test -- src/features/settings/components/SettingsView.test.tsx src/features/home/components/Home.test.tsx src/features/settings/hooks/useAppSettings.test.ts`
  - `cargo test --manifest-path src-tauri/Cargo.toml translate_tool_call_event_includes_server_and_tool`
  - `cargo test --manifest-path src-tauri/Cargo.toml translate_tool_call_update_uses_cached_tool_identity`
